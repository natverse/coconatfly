<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Multi dataset cosine clustering"><title>Multi dataset cosine clustering — multi_connection_table • coconatfly</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multi dataset cosine clustering — multi_connection_table"><meta property="og:description" content="Multi dataset cosine clustering"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">coconatfly</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/flyconnectome/coconatfly/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Multi dataset cosine clustering</h1>
      <small class="dont-index">Source: <a href="https://github.com/flyconnectome/coconatfly/blob/HEAD/R/cosine.R" class="external-link"><code>R/cosine.R</code></a></small>
      <div class="d-none name"><code>cf_cosine_plot.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Multi dataset cosine clustering</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">multi_connection_table</span><span class="op">(</span></span>
<span>  <span class="va">ids</span>,</span>
<span>  partners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"inputs"</span>, <span class="st">"outputs"</span><span class="op">)</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"type"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cf_cosine_plot</span><span class="op">(</span></span>
<span>  ids <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  partners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"outputs"</span>, <span class="st">"inputs"</span><span class="op">)</span>,</span>
<span>  labRow <span class="op">=</span> <span class="st">"{type}_{coconatfly::abbreviate_datasets(dataset)}{side}"</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>  heatmap <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  matrix <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  interactive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  drop_dataset_prefix <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"zero"</span>, <span class="st">"drop"</span><span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ward.D"</span>, <span class="st">"single"</span>, <span class="st">"complete"</span>, <span class="st">"average"</span>, <span class="st">"mcquitty"</span>, <span class="st">"median"</span>, <span class="st">"centroid"</span>,</span>
<span>    <span class="st">"ward.D2"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>ids</dt>
<dd><p>A set of across dataset <code><a href="keys.html">keys</a></code> <em>or</em> neuron ids
wrapped by <code><a href="cf_ids.html">cf_ids</a></code> <em>or</em> a dataframe compatible with the
<code><a href="keys.html">keys</a></code> function.</p></dd>


<dt>partners</dt>
<dd><p>Whether to return inputs or outputs</p></dd>


<dt>threshold</dt>
<dd><p>return only edges with at least this many matches. 0 is an
option since neuprint sometimes returns 0 weight edges.</p></dd>


<dt>group</dt>
<dd><p>The name or the grouping column for partner connectivity
(defaults to <code>"type"</code>) or a logical where <code>group=FALSE</code> means no
grouping (see details).</p></dd>


<dt>...</dt>
<dd><p>Additional arguments passed to <code><a href="https://rdrr.io/r/stats/heatmap.html" class="external-link">heatmap</a></code></p></dd>


<dt>labRow</dt>
<dd><p>Optionally, either string that can be interpolated by
<code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></code> <em>or</em> a character vector matching the number of
neurons specified by <code>ids</code>. See <b>details</b> for an important
limitation in the second case.</p></dd>


<dt>heatmap</dt>
<dd><p>A logical indicating whether or not to plot the heatmap
<em>OR</em> a function to plot the heatmap whose argument names are
compatible with <code>stats::<a href="https://rdrr.io/r/stats/heatmap.html" class="external-link">heatmap</a></code>. <code>gplots::heatmap.2</code> is a
good example. Defaults to <code>TRUE</code> therefore plotting the full heatmap
with <code>stats::<a href="https://rdrr.io/r/stats/heatmap.html" class="external-link">heatmap</a></code>.</p></dd>


<dt>matrix</dt>
<dd><p>Whether to return the raw cosine matrix (rather than a
heatmap/dendrogram)</p></dd>


<dt>interactive</dt>
<dd><p>Whether to plot an interactive heatmap (allowing zooming
and id selection). See details.</p></dd>


<dt>drop_dataset_prefix</dt>
<dd><p>Whether to remove dataset prefix such as
<code>hb:</code> or <code>fw:</code> from dendrograms. This is useful when reviewing
neurons in interactive mode.</p></dd>


<dt>nas</dt>
<dd><p>What to do with entries that have NAs. Default is to set them to 0
similarity.</p></dd>


<dt>method</dt>
<dd><p>The cluster method to use (see <code><a href="https://rdrr.io/r/stats/hclust.html" class="external-link">hclust</a></code>)</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p><code>multi_connection_table</code> returns a connectivity dataframe as
  returned by <code>cf_partners</code> but with an additional column</p>
<p></p>
<p><code>partners</code> which indicates (for each row) whether the partner neurons
  are the input or output neurons.</p>


<p>The result of <code><a href="https://rdrr.io/r/stats/heatmap.html" class="external-link">heatmap</a></code> invisibly including the row and
  column dendrograms <em>or</em> when <code>heatmap=FALSE</code>, an</p>
<p></p>
<p><code><a href="https://rdrr.io/r/stats/hclust.html" class="external-link">hclust</a></code> dendrogram <em>or</em> when <code>maxtrix=TRUE</code> a cosine
  matrix.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><code>group=FALSE</code> only makes sense for single dataset clustering -
  type labels are essential for linking connectivity across datasets. However
  <code>group=FALSE</code> can be useful e.g. for co-clustering columnar elements
  in the visual system that have closely related partners usually because
  they are in neighbouring columns. At the time of writing, there is no
  metadata support in FANC so <code>group=FALSE</code> is the only option there.</p>
<p><code>group</code> can be set to other metadata columns such as <code>class</code> or
  <code>hemilineage</code>, <code>serial</code> (serially homologous cell group) if
  available. This can reveal other interesting features of organisation.</p>
<p>The <code>labRow</code> argument is most conveniently specified as a length 1
  string to be interpolated by <code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></code>; this will happen in the
  context of a data frame generated by <code><a href="cf_meta.html">cf_meta</a></code>. One reason why
  this is convenient is that you do not have to think about matching up the
  labels to the order of neurons in the dendrogram</p>
<p>However, if you need to use additional information for your labels not
  present in the <code><a href="cf_meta.html">cf_meta</a></code> data then you will need to generate
  your own <code>labRow</code> vector. The recommended way to do this is to use
  <code><a href="cf_meta.html">cf_meta</a></code> to fetch the metadata for your neurons and then to
  construct an additional column with your preferred label. This ensures that
  each entry in the <code>labRow</code> argument can be matched to a specific
  neuron (defined by the <code>key</code> column of the metadata data frame).</p>
<p>Note that if you try to pass a user defined <code>labRow</code> character vector
  without supplying an explicitly ordered set of neurons to the <code>ids</code>
  argument then you will get an error. This is because <code>cf_cosine_plot</code>
  has no way of knowing which label corresponds to which neuron, almost
  certainly resulting in incorrect row labels on your dendrogram.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># basic cosine clustering, in this case for one dataset</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/type:LAL00.+"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/748 output partner types with total weight 0/15291</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/690 input partner types with total weight 0/11078</span>
<span class="r-plt img"><img src="cf_cosine_plot-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># same but dropping the dataset prefix in the column labels</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/type:LAL00.+"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  drop_dataset_prefix <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/748 output partner types with total weight 0/15291</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/690 input partner types with total weight 0/11078</span>
<span class="r-plt img"><img src="cf_cosine_plot-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># only cluster by inputs</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/type:LAL00.+"</span><span class="op">)</span>, partners<span class="op">=</span><span class="st">'in'</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/690 input partner types with total weight 0/11078</span>
<span class="r-plt img"><img src="cf_cosine_plot-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># or outputs</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/type:LAL00.+"</span><span class="op">)</span>, partners<span class="op">=</span><span class="st">'in'</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/690 input partner types with total weight 0/11078</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># the same but without grouping partner connectivity by type</span></span></span>
<span class="r-in"><span><span class="co"># only makes sense for single dataset plots</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/type:LAL00.+"</span><span class="op">)</span>, group <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="cf_cosine_plot-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Using user supplied row labels</span></span></span>
<span class="r-in"><span><span class="co"># e.g. because you have some labels of your own that you want to add</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘dplyr’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:nat’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     intersect, setdiff, union</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:stats’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     filter, lag</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following objects are masked from ‘package:base’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     intersect, setdiff, setequal, union</span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/" class="external-link">glue</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lalmeta</span><span class="op">=</span><span class="fu"><a href="cf_meta.html">cf_meta</a></span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/type:LAL00.+"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># NB left_join requires the id columns to have the same character data type</span></span></span>
<span class="r-in"><span><span class="va">mytypes</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5813047453</span>, <span class="fl">1011611587</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  mytype<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alice"</span>, <span class="st">'bob'</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># NB glue::glue functions makes the label using column names</span></span></span>
<span class="r-in"><span><span class="va">lalmeta2</span><span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">lalmeta</span>, <span class="va">mytypes</span>, by<span class="op">=</span><span class="st">'id'</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>label<span class="op">=</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">'{type}_{side} :: {mytype}'</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lalmeta2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           id pre post upstream downstream status    statusLabel     voxels</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 5813047453 943 2867     2867       7967 Traced Roughly traced 1709019324</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 1011611587 876 2392     2392       8542 Traced Roughly traced 1502700413</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 5813041304 288  905      905       2089 Traced Roughly traced  695312778</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4  894362173 208  469      469       1703 Traced Roughly traced  469303915</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 1572520204 126  474      474        863 Traced Roughly traced  402431356</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 5901201676 120  383      383        832 Traced Roughly traced  360821541</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   cropped instance   type cellBodyFiber notes soma side class group   dataset</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1   FALSE LAL001_R LAL001         ADL02  &lt;NA&gt; TRUE    R  &lt;NA&gt;  &lt;NA&gt; hemibrain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2   FALSE LAL002_R LAL002         ADL02  &lt;NA&gt; TRUE    R  &lt;NA&gt;  &lt;NA&gt; hemibrain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   FALSE LAL003_R LAL003         ADL06  &lt;NA&gt; TRUE    R  &lt;NA&gt;  &lt;NA&gt; hemibrain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   FALSE LAL004_R LAL004         ADL06  &lt;NA&gt; TRUE    R  &lt;NA&gt;  &lt;NA&gt; hemibrain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5   FALSE LAL005_R LAL005         ADL06  &lt;NA&gt; TRUE    R  &lt;NA&gt;  &lt;NA&gt; hemibrain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6   FALSE LAL005_R LAL005         ADL06  &lt;NA&gt; TRUE    R  &lt;NA&gt;  &lt;NA&gt; hemibrain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             key mytype             label</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 hb:5813047453  alice LAL001_R :: alice</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 hb:1011611587    bob   LAL002_R :: bob</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 hb:5813041304   &lt;NA&gt;    LAL003_R :: NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4  hb:894362173   &lt;NA&gt;    LAL004_R :: NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 hb:1572520204   &lt;NA&gt;    LAL005_R :: NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 hb:5901201676   &lt;NA&gt;    LAL005_R :: NA</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># now use that in the plot</span></span></span>
<span class="r-in"><span><span class="co"># NB with function allows cf_cosine_plot to use dataframe columns directly</span></span></span>
<span class="r-in"><span><span class="va">lalmeta2</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="va">key</span>, labRow<span class="op">=</span><span class="va">label</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/748 output partner types with total weight 0/15291</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/690 input partner types with total weight 0/11078</span>
<span class="r-plt img"><img src="cf_cosine_plot-5.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># bigger clustering</span></span></span>
<span class="r-in"><span><span class="va">lalhc</span><span class="op">=</span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/type:LAL.+"</span><span class="op">)</span>, heatmap<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/17386 output partner types with total weight 0/331470</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/23297 input partner types with total weight 0/435509</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>diag(V) has non-positive or non-finite entries; finite result is doubtful</span>
<span class="r-in"><span><span class="va">lalmeta</span><span class="op">=</span><span class="fu"><a href="cf_meta.html">cf_meta</a></span><span class="op">(</span><span class="va">lalhc</span><span class="op">$</span><span class="va">labels</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lalmeta</span><span class="op">=</span><span class="fu">coconat</span><span class="fu">::</span><span class="fu"><a href="https://natverse.org/coconat/reference/add_cluster_info.html" class="external-link">add_cluster_info</a></span><span class="op">(</span><span class="va">lalmeta</span>, <span class="va">lalhc</span>, h<span class="op">=</span><span class="fl">0.75</span>, idcol<span class="op">=</span><span class="st">'key'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co">## The previous examples are for single datasets to avoid authentication issues</span></span></span>
<span class="r-in"><span><span class="co">## on the build server, but similar queries could be run for multiple datasets</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>flywire<span class="op">=</span><span class="st">"/type:LAL.+"</span>, malecns<span class="op">=</span><span class="st">"/type:LAL.+"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="st">"/type:LAL.+"</span>, datasets<span class="op">=</span><span class="st">'brain'</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># same as since the default is brain</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="st">"/type:LAL.+"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># just make the hclust dendrogram</span></span></span>
<span class="r-in"><span><span class="va">lalhc</span><span class="op">=</span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="st">"/type:LAL.+"</span><span class="op">)</span>, heatmap<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lalmeta</span><span class="op">=</span><span class="fu"><a href="cf_meta.html">cf_meta</a></span><span class="op">(</span><span class="va">lalhc</span><span class="op">$</span><span class="va">labels</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lalmeta</span><span class="op">=</span><span class="fu">coconat</span><span class="fu">::</span><span class="fu"><a href="https://natverse.org/coconat/reference/add_cluster_info.html" class="external-link">add_cluster_info</a></span><span class="op">(</span><span class="va">lalmeta</span>, <span class="va">lalhc</span>, h<span class="op">=</span><span class="fl">0.75</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># look at the results interactively</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="st">"/type:LAL.+"</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># Showcase examples using multi_connection_table to allow</span></span></span>
<span class="r-in"><span><span class="co"># only a subset of partners to be used for typing</span></span></span>
<span class="r-in"><span><span class="va">mct</span><span class="op">=</span><span class="fu">multi_connection_table</span><span class="op">(</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">"/lLN2.+"</span><span class="op">)</span>, partners<span class="op">=</span><span class="st">'in'</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 0/63218 input partner types with total weight 0/412813</span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="va">mct</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="cf_cosine_plot-6.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mct2</span><span class="op">=</span><span class="va">mct</span> <span class="op"><a href="pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"PN"</span>,<span class="va">type</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="va">mct2</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="cf_cosine_plot-7.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mct3</span><span class="op">=</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="st">"/type:lLN2.+"</span>, datasets<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemibrain"</span>, <span class="st">"flywire"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">multi_connection_table</span><span class="op">(</span><span class="va">.</span>, partners<span class="op">=</span><span class="st">'in'</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"LN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">"LN"</span>,</span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"RN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">"RN"</span>,</span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^M.*PN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">'mPN'</span>,</span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"PN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">'uPN'</span>,</span></span>
<span class="r-in"><span>   <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">'other'</span></span></span>
<span class="r-in"><span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="co"># try merging connectivity for partners that don't have much specificity</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">class</span><span class="op">==</span><span class="st">"RN"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"_.+"</span>, <span class="st">""</span>, <span class="va">type</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="va">class</span><span class="op">==</span><span class="st">"uPN"</span> <span class="op">~</span> <span class="st">'uPN'</span>,</span></span>
<span class="r-in"><span>  <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">type</span></span></span>
<span class="r-in"><span>  <span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required namespace: git2r</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 24335/107368 input partner types with total weight 234059/838394</span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">mct3</span><span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="co"># remove RN/uPN connectivity could also use the merged connectivity</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">class</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RN"</span>, <span class="st">"uPN"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">cf_cosine_plot</span><span class="op">(</span>interactive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># This time focus in on a small number of query neurons</span></span></span>
<span class="r-in"><span><span class="va">mct3</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>query_key<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">partners</span><span class="op">==</span><span class="st">'outputs'</span>, <span class="va">pre_key</span>, <span class="va">post_key</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">query_key</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="st">'/type:lLN2(T_[bde]|X08)'</span>,</span></span>
<span class="r-in"><span>    datasets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemibrain"</span>, <span class="st">"flywire"</span><span class="op">)</span>, keys <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="cf_cosine_plot-8.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># another worked example lLN1 neurons</span></span></span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="va">lLN1</span><span class="op">=</span><span class="fu"><a href="cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="st">"/type:lLN1_.+"</span>, datasets<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hemibrain"</span>, <span class="st">"flywire"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">multi_connection_table</span><span class="op">(</span><span class="va">.</span>, partners<span class="op">=</span><span class="st">'in'</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"LN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">"LN"</span>,</span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"RN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">"RN"</span>,</span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^M.*PN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">'mPN'</span>,</span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"PN"</span>, <span class="va">type</span><span class="op">)</span> <span class="op">~</span> <span class="st">'uPN'</span>,</span></span>
<span class="r-in"><span>   <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">'other'</span></span></span>
<span class="r-in"><span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">class</span><span class="op">==</span><span class="st">"RN"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"_.+"</span>, <span class="st">""</span>, <span class="va">type</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="va">class</span><span class="op">==</span><span class="st">"uPN"</span> <span class="op">~</span> <span class="st">'uPN'</span>,</span></span>
<span class="r-in"><span>  <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">type</span></span></span>
<span class="r-in"><span>  <span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Matching types across datasets. Dropping 7237/17265 input partner types with total weight 124784/234441</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">lLN1</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">class</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RN"</span>, <span class="st">"uPN"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">cf_cosine_plot</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="cf_cosine_plot-9.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

