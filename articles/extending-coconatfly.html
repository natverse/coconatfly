<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4. Extending coconatfly with external data sources • coconatfly</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="4. Extending coconatfly with external data sources">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">coconatfly</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.4.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/natverse/coconatfly/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>4. Extending coconatfly with external data sources</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/natverse/coconatfly/blob/master/vignettes/extending-coconatfly.Rmd" class="external-link"><code>vignettes/extending-coconatfly.Rmd</code></a></small>
      <div class="d-none name"><code>extending-coconatfly.Rmd</code></div>
    </div>

    
    
<p>This vignette explains how and why developers and end users might
want to extend coconatfly to support an</p>
<div class="section level2">
<h2 id="tldr">tldr<a class="anchor" aria-label="anchor" href="#tldr"></a>
</h2>
<p>Register a new external dataset (or override an existing one) by
doing:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">coconat</span><span class="fu">::</span><span class="fu"><a href="https://natverse.org/coconat/reference/register_dataset.html" class="external-link">register_dataset</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">'fcns'</span>, shortname <span class="op">=</span> <span class="st">'fc'</span>, namespace <span class="op">=</span> <span class="st">'coconatfly'</span>,</span>
<span>  metafun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">ids</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># first column must be within dataset id</span></span>
<span>    <span class="co"># additional metadata can include columns like type and side</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id<span class="op">=</span><span class="fl">1234</span>, type<span class="op">=</span><span class="st">"DNp25"</span>, side<span class="op">=</span><span class="st">"L"</span>, class<span class="op">=</span><span class="st">'descending_neuron'</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  partnerfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ids</span>, <span class="va">partners</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"inputs"</span>, <span class="st">"outputs"</span><span class="op">)</span>, <span class="va">threshold</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># data frame should contain 3 columns</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>query<span class="op">=</span><span class="fl">1234</span>, partner<span class="op">=</span><span class="fl">4567</span>, weight<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Read on for more details, including additional functions that you can
provide.</p>
</div>
<div class="section level2">
<h2 id="introduction">introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>coconatfly has built-in support for a number of datasets
corresponding to named arguments of the <code><a href="../reference/cf_ids.html">cf_ids()</a></code>
function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/coconatfly" class="external-link">coconatfly</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cf_ids.html">cf_ids</a></span><span class="op">(</span>hemibrain<span class="op">=</span><span class="st">'LAL008'</span>, flywire<span class="op">=</span><span class="st">'LAL008'</span>, expand <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">flywire</span> <span style="color: #555555;">[2 ids]</span>: 720575940639138382 720575940643829704</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">hemibrain</span> <span style="color: #555555;">[2 ids]</span>: 1170352367 1605181883</span></span></code></pre></div>
<p>While it is likely that additional datasets will be added over time,
there are reasons why adding more and more built-in datasets could cause
trouble in the long term. These include</p>
<ul>
<li>introducing additional dependencies that make
<code>coconatfly</code> package installation increasingly fragile</li>
<li>slower development by relying on lead developer(s) for
integration.</li>
</ul>
<p>Conversely giving users a mechanism to add external datasets gives
benefits including:</p>
<ul>
<li>rapid support for new datasets even when they are evolving</li>
<li>support for private/pre-release data</li>
<li>support for new kinds of metadata source</li>
<li>ability for end users to modify behaviour of existing built-in
datasets e.g. fix a few cell types for a public dataset.</li>
</ul>
<p>In order to achieve this you must tell coconatfly about your new
dataset, what it is called and what functions are available to get the
relevant data.</p>
</div>
<div class="section level2">
<h2 id="registering-a-dataset">registering a dataset<a class="anchor" aria-label="anchor" href="#registering-a-dataset"></a>
</h2>
<p>The process of telling coconatfly about a new dataset is called
registration and relies on a function in the base <code>coconat</code>
package called <code><a href="https://natverse.org/coconat/reference/register_dataset.html" class="external-link">coconat::register_dataset()</a></code>.</p>
<p>You need to supply both <strong>information</strong> about the
dataset and <strong>functions</strong> that interact with it. Some of
this is essential, other parts are optional. Starting with the
information, something like this would be standard:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">coconat</span><span class="fu">::</span><span class="fu"><a href="https://natverse.org/coconat/reference/register_dataset.html" class="external-link">register_dataset</a></span><span class="op">(</span></span>
<span>  <span class="co"># crucial arguments</span></span>
<span>  name <span class="op">=</span> <span class="st">'fcns'</span>, shortname <span class="op">=</span> <span class="st">'fc'</span>, namespace <span class="op">=</span> <span class="st">'coconatfly'</span>, </span>
<span>  <span class="co"># optional information</span></span>
<span>  species <span class="op">=</span> <span class="st">'Drosophila melanogaster'</span>, sex <span class="op">=</span> <span class="st">'F'</span>, age <span class="op">=</span> <span class="st">'adult 7d'</span>,</span>
<span>  description <span class="op">=</span> <span class="st">'Complete female CNS dataset'</span>,</span>
<span>  <span class="co"># [functions omitted]</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The <code>name</code> argument gives the dataset name that will be
used in the <code><a href="../reference/cf_ids.html">cf_ids()</a></code> function. Note that
<code>cf_ids</code> will not have an argument named <code>fcns</code>
but after dataset registration it will correctly process specifications
like:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cf_ids.html">cf_ids</a></span><span class="op">(</span>fcns<span class="op">=</span><span class="st">'/DNa02'</span>, expand <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>which with give</p>
<pre><code>fcns [2 ids]: 1234 5678</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/cf_ids.html">cf_ids</a></span><span class="op">(</span>rhubarb<span class="op">=</span><span class="st">'/DNa02'</span>, expand <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Besides the name argument the only other completely essential
argument is <code>namespace = 'coconatfly'</code>. This is what ensures
that the <code>coconatfly</code> package will know about this
dataset.</p>
<p>All the optional information is nice to have but not really used at
the moment.</p>
</div>
<div class="section level2">
<h2 id="dataset-functions">dataset functions<a class="anchor" aria-label="anchor" href="#dataset-functions"></a>
</h2>
<p>It’s great to have told coconatfly the name of your dataset, but that
doesn’t provide any real functionality. In addition you’ll want to
supply functions that do metadata or connectivity queries. There are
three named arguments in <code><a href="https://natverse.org/coconat/reference/register_dataset.html" class="external-link">coconat::register_dataset()</a></code> each
of which expects to be passed a function:</p>
<ul>
<li>
<code>idfun</code> process queries or ids</li>
<li>
<code>metafun</code> return metadata for given ids or query</li>
<li>
<code>partnerfun</code> return connectivity information</li>
</ul>
<div class="section level3">
<h3 id="idfun">idfun<a class="anchor" aria-label="anchor" href="#idfun"></a>
</h3>
<p><code>idfun</code> is the most basic it turns ids or queries into a
character vector of ids.</p>
<p>Typical queries might look like: <code>ids='/type:DNa02'</code> to
find descending neurons with cell type DNa02.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myidfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ids</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># return value should be character vector (integer64 is also accepted)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Although basic, it is not essential to specify an <code>idfun</code>
as it will by default use the supplied <code>metadata</code> function to
handle queries.</p>
</div>
<div class="section level3">
<h3 id="metafun">metafun<a class="anchor" aria-label="anchor" href="#metafun"></a>
</h3>
<p>The function to return metadata is a little more complicated. The
input <code>ids</code> specification will be the same as for the
previous function. But this time we return a data frame.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mymetafun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ids</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">123</span>, <span class="fl">456</span><span class="op">)</span><span class="op">)</span>, side<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"L"</span>, <span class="st">"R"</span><span class="op">)</span>, class<span class="op">=</span><span class="st">'descending_neuron'</span>, subclass<span class="op">=</span><span class="st">'DNa'</span>, type<span class="op">=</span><span class="st">'DNp42'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The return value should be a <code>data.frame</code> whose first
column is the within dataset <code>id</code>; although normally numeric,
we recommend encoding as a character. Additional columns can include
<code>side</code>, <code>class</code>, <code>subclass</code>,
<code>subsubclass</code>, <code>type</code>, <code>lineage</code>,
<code>instance</code>. Note that side should be encoded as
<code>L</code>, <code>R</code>, <code>M</code> (for midline) or
<code>NA</code> for unknown. Additional columns can be returned but may
be dropped by downstream functions. Note that although it is recommended
that the id should be a character vector, you can also use the
<code>integer64</code> type returned by the <code>bit64</code> package
for some speed/size savings but these are likely to be minor.</p>
</div>
<div class="section level3">
<h3 id="partnerfun">partnerfun<a class="anchor" aria-label="anchor" href="#partnerfun"></a>
</h3>
<p>The final function gives per neuron information about
connectivity.</p>
<p>In addition to the ids (which can be queries processed by the idfun
or metafun above.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_partners</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ids</span>, <span class="va">partners</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'in'</span>, <span class="va">out</span><span class="op">)</span>, <span class="va">threshold</span><span class="op">=</span><span class="fl">1L</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/cf_ids.html">cf_ids</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="inheriting-vs-defining">Inheriting vs defining<a class="anchor" aria-label="anchor" href="#inheriting-vs-defining"></a>
</h2>
<p>One reason to register a new dataset is if you want to tweak an
existing dataset. For example you might decide that you need to modify
some cell type labels. You can use the inherits argument to simplify
this. For example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_banc_meta</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ids</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">meta</span><span class="op">=</span><span class="fu"><a href="../reference/cf_meta.html">cf_meta</a></span><span class="op">(</span><span class="fu"><a href="../reference/cf_ids.html">cf_ids</a></span><span class="op">(</span>banc<span class="op">=</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">meta</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case-and-replace-when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">type</span><span class="op">==</span><span class="st">'AN09B001'</span> <span class="op">~</span> <span class="st">"AN05B102"</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">type</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">coconat</span><span class="fu">::</span><span class="fu"><a href="https://natverse.org/coconat/reference/register_dataset.html" class="external-link">register_dataset</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'bancy'</span>, shortname <span class="op">=</span> <span class="st">'by'</span>, </span>
<span>                          metafun <span class="op">=</span> <span class="va">my_banc_meta</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gregory Jefferis.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
